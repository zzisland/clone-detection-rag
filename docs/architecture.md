# 项目架构文档

## 系统架构概览

代码克隆检测RAG助手采用模块化设计，主要包含以下核心组件：

```
┌─────────────────────────────────────────────────────────────┐
│                    Streamlit Web UI                         │
│                   (用户交互界面)                              │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                    RAG Core                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   问答模块   │  │  分析模块    │  │  比较模块    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                  Retriever                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  通用检索    │  │  分类检索    │  │  混合检索    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                Data Ingestor                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  文档处理    │  │  向量化      │  │  存储管理    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                  ChromaDB                                  │
│              (向量数据库)                                  │
└─────────────────────────────────────────────────────────────┘
```

> **基础概念**: 详见 [克隆检测基础](data/papers/clone_detection_basics.txt)

## 核心组件详解

### 1. Streamlit Web UI
**功能**: 提供用户友好的Web界面
**技术**: Streamlit
**特性**:
- 实时对话界面
- 系统状态监控
- 配置管理
- 多模式交互

### 2. RAG Core
**功能**: 核心问答和逻辑处理
**技术**: LangChain + Qwen2.5-Coder
**组件**:
- **问答模块**: 处理概念性问题
- **分析模块**: 分析代码片段
- **比较模块**: 对比工具和方法

### 3. Retriever
**功能**: 智能检索相关文档
**技术**: ChromaDB + HuggingFace Embeddings
**策略**:
- **通用检索**: 基于语义相似度
- **分类检索**: 按文档类型过滤
- **混合检索**: 结合多种策略

### 4. Data Ingestor
**功能**: 数据摄取和预处理
**技术**: Python + 多种文档解析器
**流程**:
- 文档格式识别
- 文本清洗和分块
- 向量化处理
- 数据库存储

### 5. ChromaDB
**功能**: 向量数据库存储
**技术**: ChromaDB
**特性**:
- 高效向量检索
- 持久化存储
- 元数据管理

## 数据流程

### 1. 数据摄取流程
```
原始文档 → 格式识别 → 文本提取 → 分块处理 → 向量化 → 存储
    ↓           ↓          ↓         ↓        ↓       ↓
  PDF/MD/TXT  解析器    清洗算法   分块器   Embedding  ChromaDB
```

### 2. 查询处理流程
```
用户问题 → 问题分类 → 检索策略 → 向量检索 → 文档排序 → 上下文构建 → 答案生成
    ↓         ↓         ↓         ↓         ↓          ↓          ↓
  Streamlit  分类器    策略选择   ChromaDB  排序算法    模板处理    Qwen模型
```

## 技术栈详情

### 前端技术
- **Streamlit 1.29.0**: Web界面框架
- **HTML/CSS**: 界面样式定制
- **JavaScript**: 交互功能增强

### 后端技术
- **Python 3.9**: 主要编程语言
- **LangChain 0.1.0**: RAG框架
- **ChromaDB 0.4.22**: 向量数据库
- **Qwen2.5-Coder**: 大语言模型

### 文档处理
- **PyPDF2**: PDF文档解析
- **pdfplumber**: 高级PDF处理
- **BeautifulSoup4**: HTML解析
- **markdown**: Markdown处理

### 机器学习
- **sentence-transformers**: 文本嵌入
- **transformers**: 模型框架
- **torch**: 深度学习框架
- **accelerate**: 模型加速

## 配置管理

### 环境变量
```bash
# 向量数据库
CHROMA_PERSIST_DIRECTORY=./data/chroma

# 文档处理
CHUNK_SIZE=1000
CHUNK_OVERLAP=200

# 检索配置
TOP_K_RETRIEVAL=5
```

### 数据目录
```python
DATA_DIRS = {
    'papers': './data/papers',
    'tools_docs': './data/tools_docs',
    'project_docs': './data/project_docs',
    'examples': './data/examples',
    'code_datasets': './data/code_datasets',
    'google_scholar_papers': './data/google_scholar_papers'
}
```

## 部署架构

### 本地部署
```
用户机器
├── Python 3.9+
├── Qwen2.5-Coder模型
├── ChromaDB数据库
└── Streamlit应用
```

### 云端部署（可选）
```
云服务器
├── Docker容器
├── GPU支持
├── 负载均衡
└── 监控系统
```

## 性能优化

### 1. 检索优化
- **向量索引**: 使用高效的向量索引算法
- **缓存机制**: 缓存常用查询结果
- **并行处理**: 支持多线程检索

### 2. 生成优化
- **模型量化**: 使用量化模型减少内存占用
- **批处理**: 批量处理提高效率
- **流式输出**: 流式生成提升用户体验

### 3. 存储优化
- **数据压缩**: 压缩向量数据
- **分片存储**: 大数据集分片存储
- **定期清理**: 清理过期数据

## 扩展性设计

### 1. 模块化架构
- **松耦合**: 组件间低耦合
- **插件化**: 支持功能插件
- **配置驱动**: 通过配置扩展功能

### 2. 数据扩展
- **多格式**: 支持新的文档格式
- **多语言**: 支持多种编程语言
- **多领域**: 扩展到其他技术领域

### 3. 功能扩展
- **API接口**: 提供RESTful API
- **插件系统**: 支持第三方插件
- **集成能力**: 与其他工具集成

## 安全性考虑

### 1. 数据安全
- **本地存储**: 数据本地化存储
- **访问控制**: 实现访问权限控制
- **数据加密**: 敏感数据加密存储

### 2. 模型安全
- **本地模型**: 使用本地模型避免数据泄露
- **输入验证**: 验证用户输入防止注入攻击
- **输出过滤**: 过滤不当输出内容

## 监控与维护

### 1. 系统监控
- **性能监控**: 监控系统性能指标
- **错误监控**: 监控和记录错误日志
- **使用统计**: 统计用户使用情况

### 2. 维护策略
- **定期更新**: 定期更新模型和依赖
- **数据备份**: 定期备份重要数据
- **版本管理**: 使用版本控制管理代码

---

**文档版本**: v1.0  
**更新日期**: 2026年1月11日  
**维护者**: 项目开发团队
